# 5.1. Конфигурирование NAT
**NAT** (Network Address Translation):
- **Что делает:** преобразует частные (внутренние) IP-адреса в публичные (внешние) и наоборот. Обычно используется для подключения локальной сети к интернету.
- **Тип преобразования:** *один-к-одному* – один частный IP-адрес сопоставляется с одним публичным IP-адресом.
- **Когда используется:** когда есть достаточно публичных IP-адресов или требуется статическое соответствие (например, для серверов).

Пример: устройство с локальным IP-адресом `192.168.1.10` получает публичный IP-адрес `203.0.113.10` для выхода в интернет.

## Вводная информация
| Сеть        | Адрес       | Маска подсети   |
|------------ |-------------|-----------------|
| A (слева)   | 192.168.1.0 | 255.255.255.0   |
| B (справа)  | 192.168.2.0 | 255.255.255.0   |
| M (M1 ↔ M2) | 10.0.1.0    | 255.255.255.0   |

### Топология
![topology](https://i.imgur.com/SdGVkX8.png)

## Базовая конфигурация сети
1. Настроим маршрутизацию в сети с помощью протокола RIP.
2. Хостам назначим соответствующие локальные адреса вручную.
> [!TIP]
> Можно настроить выдачу IP-адресов и другой информации с помощью DHCP, но это усложнит процесс проверки трансляций адресов NAT.

### Маршрутизатор M1
```yaml
int fa0/0
    ip address 192.168.1.1 255.255.255.0
    no shutdown
    exit
    
int s2/0
    ip address 10.0.1.1 255.255.255.0
    no shutdown
    exit

# Конфигурирование RIP
router rip
    network 10.0.1.0
    network 192.168.1.0
    end
```

### Маршрутизатор M2
```yaml
int fa0/0
    ip address 192.168.2.1 255.255.255.0
    no shutdown
    exit

int s2/0
    ip address 10.0.1.2 255.255.255.0
    no shutdown
    exit

router rip
    network 10.0.1.0
    network 192.168.2.0
    end
```

## Конфигурирование NAT
Настроим NAT так, чтобы все хосты из сети `192.168.1.0/24` могли выходить во внешнюю сеть `10.0.1.0/24` через интерфейс с адресом из этой сети.

То есть каждому хосту в локальной сети будет сопоставлен внешний IP-адрес из сети `10.0.1.0/24`.

При создании пула адресов NAT требуется указать диапазон внешних адресов, которые могут быть использованы для сопоставления. В этом примере будем использовать диапазон `10.0.1.100`–`10.0.1.200`.

Тогда частный пример трансляции адресов будет выглядеть так:
| Локальный адрес |   | Внешний адрес |
|-----------------|---|---------------|
| 192.168.1.2     | ↔ | 10.0.1.100    |
| 192.168.1.3     | ↔ | 10.0.1.101    |
| 192.168.1.4     | ↔ | 10.0.1.102    |

В действительности трансляция выполняется в зависимости от занятых адресов в пуле, количестве активных хостов во внутренней сети и т. д.

### Маршрутизатор M1
Назначим внутренние и внешние интерфейсы NAT.
- Внутренний интерфейс – интерфейс локальной сети, для хостов которых будет выполняться трансляция во внешние адреса.
- Внешний интерфейс – интерфейс во внешнюю (глобальную) сеть.
```yaml
int fa0/0
    ip nat inside
    exit

int s2/0
    ip nat outside
    exit
```
Создадим пул внешних IP-адресов для NAT с именем `NAT-POOL` и упомянутым ранее диапазоном адресов.
```yaml
ip nat pool NAT-POOL 10.0.1.100 10.0.1.200 netmask 255.255.255.0
```
Определим ACL для всех хостов внутренней сети.
```yaml
access-list 1 permit 192.168.1.0 0.0.0.255
```
Свяежм внутреннюю сеть с пулом внешних IP-адресов.
```yaml
ip nat inside source list 1 pool NAT-POOL
```

## Проверка
На каждом из трех хостов запустим команду `ping -t 192.168.2.2`, которая будет выполняться неограниченное количество времени.

### Маршрутизатор M1
Просмотрим статистику работы NAT
```yaml
show ip nat statistics
```
```yaml
Total translations: 29 (0 static, 29 dynamic, 29 extended)
Outside Interfaces: Serial2/0
Inside Interfaces: FastEthernet0/0
Hits: 123  Misses: 363
Expired translations: 111
Dynamic mappings:
-- Inside Source
access-list 1 pool NAT-POOL refCount 29
 pool NAT-POOL: netmask 255.255.255.0
       start 10.0.1.100 end 10.0.1.200
       type generic, total addresses 101 , allocated 3 (1%), misses 0
```
Просмотрим активные трансляции адресов NAT
```yaml
show ip nat translations
```
```yaml
Pro  Inside global     Inside local       Outside local      Outside global
# ...
icmp 10.0.1.101:181    192.168.1.2:181    192.168.2.2:181    192.168.2.2:181
# ...
icmp 10.0.1.102:112    192.168.1.3:112    192.168.2.2:112    192.168.2.2:112
# ...
icmp 10.0.1.103:113    192.168.1.4:113    192.168.2.2:113    192.168.2.2:113
# ...
```

## Статический маппинг
Если требуется, чтобы определенному хосту всегда сопоставлялся один и тот же внешний адрес, то можно задать статический маппинг
```yaml
ip nat inside source static <local-address> <global-address>
```
Например задать хосту `192.168.1.2` внешний адрес `10.0.1.100`
```yaml
ip nat inside source static 192.168.1.2 10.0.1.100
```