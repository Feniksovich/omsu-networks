# 5.1. Конфигурирование PAT
**PAT** (Port Address Translation):
- **Что делает:** позволяет множеству устройств с частными IP-адресами использовать один публичный IP-адрес, добавляя уникальные номера портов для идентификации каждого соединения.
- **Тип преобразования:** *многие-к-одному* – много частных IP-адресов сопоставляются с одним публичным IP-адресом с использованием разных портов.
- **Когда используется:** когда публичных IP-адресов мало, например, в домашних или офисных сетях.

Пример: устройства `192.168.1.10:port1` и `192.168.1.11:port2` выходят в интернет через один публичный IP `203.0.113.10`, но с разными портами (`203.0.113.10:portA` и `203.0.113.10:portB`).

## Вводная информация
| Сеть        | Адрес       | Маска подсети   |
|------------ |-------------|-----------------|
| A (слева)   | 192.168.1.0 | 255.255.255.0   |
| B (справа)  | 192.168.2.0 | 255.255.255.0   |
| M (M1 ↔ M2) | 10.0.1.0    | 255.255.255.0   |

### Топология
![topology](https://i.imgur.com/SdGVkX8.png)

## Базовая конфигурация сети
1. Настроим маршрутизацию в сети с помощью протокола RIP.
2. Хостам назначим соответствующие локальные адреса вручную.
> [!TIP]
> Можно настроить выдачу IP-адресов и другой информации с помощью DHCP, но это усложнит процесс проверки трансляций адресов PAT.

### Маршрутизатор M1
```yaml
int fa0/0
    ip address 192.168.1.1 255.255.255.0
    no shutdown
    exit
    
int s2/0
    ip address 10.0.1.1 255.255.255.0
    no shutdown
    exit

# Конфигурирование RIP
router rip
    network 10.0.1.0
    network 192.168.1.0
    end
```

### Маршрутизатор M2
```yaml
int fa0/0
    ip address 192.168.2.1 255.255.255.0
    no shutdown
    exit

int s2/0
    ip address 10.0.1.2 255.255.255.0
    no shutdown
    exit

router rip
    network 10.0.1.0
    network 192.168.2.0
    end
```

## Конфигурирование PAT
Настроим PAT так, чтобы все хосты из сети `192.168.1.0/24` могли выходить во внешнюю сеть `10.0.1.0/24` через интерфейс с общим адресом `10.0.1.1`.

То есть каждому хосту в локальной сети будет сопоставлен один внешний IP-адрес `10.0.1.1`.

Тогда частный пример трансляции адресов будет выглядеть так:
| Локальный адрес   |   | Внешний адрес     |
|-------------------|---|-------------------|
| 192.168.1.2:1     | ↔ | **10.0.1.1**:1337 |
| 192.168.1.3:2     | ↔ | **10.0.1.1**:1338 |
| 192.168.1.4:3     | ↔ | **10.0.1.1**:1339 |

### Маршрутизатор M1
Назначим внутренние и внешние интерфейсы PAT.
- Внутренний интерфейс – интерфейс локальной сети, для хостов которых будет выполняться трансляция во внешние адреса.
- Внешний интерфейс – интерфейс во внешнюю (глобальную) сеть.
```yaml
int fa0/0
    ip nat inside
    exit

int s2/0
    ip nat outside
    exit
```
Определим ACL для всех хостов внутренней сети
```yaml
access-list 1 permit 192.168.1.0 0.0.0.255
```
Зададим работу PAT, где внешний интерфейс Serial2/0, связанный с внешней сетью `10.0.1.0.24`, используется с перегрузкой портов
```yaml
ip nat inside source list 1 interface s2/0 overload
```

## Проверка
На каждом из трех хостов запустим команду `ping -t 192.168.2.2`, которая будет выполняться неограниченное количество времени.

### Маршрутизатор M1
Просмотрим статистику работы PAT
```yaml
show ip nat statistics
```
```yaml
Total translations: 82 (0 static, 82 dynamic, 82 extended)
Outside Interfaces: Serial2/0
Inside Interfaces: FastEthernet0/0
Hits: 149  Misses: 246
Expired translations: 68
Dynamic mappings:
```
Просмотрим активные трансляции адресов PAT
```yaml
show ip nat translations
```
```yaml
Pro  Inside global     Inside local       Outside local      Outside global
# ...
icmp 10.0.1.1:1        192.168.1.2:1      192.168.2.2:13     192.168.2.2:1024
# ...
icmp 10.0.1.1:10       192.168.1.3:10     192.168.2.2:10     192.168.2.2:10
# ...
icmp 10.0.1.1:1024     192.168.1.4:1      192.168.2.2:1      192.168.2.2:1024
# ...
```