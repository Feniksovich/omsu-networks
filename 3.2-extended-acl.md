# 3.2. Конфигурирование расширенных списков доступа
ACL (Access Control List) – список доступа.

## Команды
Создание правил для расширенных ACL
```yaml
access-list <number> <permit|deny> <protocol> <source> [wildcard mask] <destination> [wildcard mask] [options]
```
1. `access-list <number>`

    `<number>` — номер ACL, определяет тип и идентификатор списка:
    - 1–99, 1300–1999: стандартные ACL (по источнику).
    - 100–199, 2000–2699: расширенные ACL (по источнику, назначению, протоколу и портам).

2. `<permit|deny>`
    - permit — разрешить указанный тип трафика, подходящий под правило.
    - deny — запретить указанный тип трафика, подходящий под правило.
3. `<protocol>`
    Протокол, к которому применяется правило:
    - `ip` — любой IP-трафик;
    - `tcp` — TCP-сессии (например, для HTTP, FTP);
    - `udp` — UDP-сессии (например, для DNS, DHCP);
    - `icmp` — сообщения ICMP (например, ping);
    - или номер протокола (например, 47 для GRE) или специфическое значение.
4. `<source>`

    Источник (IP-адрес или сеть), по которому фильтруется трафик:
    - IP-адрес: например, 192.168.1.2
    - Сеть: например, 192.168.1.0
    - `any` — любой источник
5. `[wildcard mask]`
    
    Маска-джокер (wildcard mask), указывает, какие биты адреса участвают в сравнении:
    
    - Маска сети: 255.255.255.0 → Wildcard Mask: 0.0.0.255
    - Для одного хоста: 0.0.0.0
    - `any` автоматически эквивалентна 0.0.0.0 255.255.255.255
6. `<destination>`
    
    Назначение (IP-адрес или сеть) — куда отправляется трафик:
    - IP-адрес: например, 192.168.1.2
    - Сеть: например, 192.168.1.0
    - `any` — любой источник
7. `[wildcard mask]`

    Wildcard Mask для адреса, как и ранее.
8. `[options]`

    Дополнительные опции, уточняющие фильтрацию:
    - Для TCP/UDP — номера портов, сервисы или диапазоны портов:
        - eq [номер/имя порта] — только на этот порт (например, eq 80 для HTTP)
        - lt/gt/neq/range [номер порта]
    - Для TCP — можно указать флаги (established и др.)
    - Для других протоколов — специфичные параметры

Удалить созданный ACL по номеру
```yaml
no access-list <number>
```

Применение ACL к интерфейсу
- `in` — фильтрация входящего трафика
- `out` — фильтрация исходящего трафика
```yaml
interface <interface_name>
    ip access-group <number> <in|out>
```

Отвзяка ACL от интерфейса
```yaml
interface <interface_name>
    no ip access-group <number> <in|out>
```

Показать конфигурацию всех ACL или ACL по номеру
```yaml
show access-lists [number]
```

## Вводная информация
| Сеть        | Адрес       | Маска подсети   |
|------------ |-------------|-----------------|
| A (слева)   | 192.168.1.0 | 255.255.255.0   |
| B (справа)  | 192.168.2.0 | 255.255.255.0   |
| M (M1 ↔ M2) | 10.0.0.0    | 255.255.255.252 |

> [!WARNING]
> Сеть M использует маску бесклассовой адресации (255.255.255.252), для работы которой требуется включение RIP v2 на соответствующих маршрутизаторах.

### Топология
![topology](https://i.imgur.com/rasnj1N.png)

## Базовая конфигурация сети
Маршрутизация в сети будет осуществляться с помощью протокола RIP v2.

### Маршрутизатор M1
```yaml
int fa0/0
    ip address 192.168.1.1 255.255.255.0
    no shutdown
    exit
    
int s2/0
    ip address 10.0.0.1 255.255.255.252
    no shutdown
    exit

# Конфигурирование RIP
router rip
    version 2           # включает поддержку VLSM (бесклассовой адресации)
    network 10.0.0.0
    network 192.168.1.0
    end
```

### Маршрутизатор M2
```yaml
int fa0/0
    ip address 192.168.2.1 255.255.255.0
    no shutdown
    exit

int s2/0
    ip address 10.0.0.2 255.255.255.252
    no shutdown
    exit

router rip
    version 2
    network 10.0.0.0
    network 192.168.2.0
    end
```

## Конфигурация списков доступа
1. Разрешим хосту 192.168.1.2 (сеть A) доступ по протоколу HTTP (TCP порт 80) к хосту 192.168.2.2 (сеть B);
2. Запретим всем остальным хостам из сети A (192.168.1.0/24) доступ по протоколу HTTP к хосту 192.168.2.2 (сеть B);
3. Разрешим весь остальной трафик.

### Маршрутизатор M1
```yaml
# Разрешить HTTP с 192.168.1.2 к 192.168.2.2
access-list 110 permit tcp host 192.168.1.2 host 192.168.2.2 eq 80

# Запретить весь другой HTTP трафик с 192.168.1.0/24 к 192.168.2.2
access-list 110 deny tcp 192.168.1.0 0.0.0.255 host 192.168.2.2 eq 80

# Разрешить остальной трафик
access-list 110 permit ip any any

int fa0/0
    ip access-group 110 in # применяет правила ACL 110 к интерфейсу на вход
    exit
```

## Проверка
### Хост 192.168.1.2
В веб-браузере (Desktop → Web Browser) при попытке обратиться по адресу http://192.168.2.2 получим сообщение "Server Reset Connection". Трафик достигает хоста 192.168.2.2, но, поскольку на нем не запущен веб-сервер, ответа нет.

Можно заменить устройство на адресе 192.168.2.2 c `PC-PT` на `Server-PT`, который имеет возможность запустить HTTP-сервер (Services → HTTP → On). В таком случае он отдаст стандартную веб-страницу.

<details>
  <summary>Сеть с Server-PT по адресу 192.168.2.2</summary>

  ![Сеть с Server-PT](https://i.imgur.com/xVMF3l8.png)
</details>


<details>
  <summary>Корректный ответ от сервера</summary>

  ![Корректный ответ от сервера](https://i.imgur.com/kVhjUFg.png)
</details>


### Хост 192.168.1.3
В веб-браузере при попытке обратиться по адресу http://192.168.2.2 получим сообщение "Request Timeout" – трафик отбрасывается маршрутизатором.


Также можно просмотреть статистику работы ACL на M1
```yaml
show access-lists 110
```
```yaml
Extended IP access list 110
    permit tcp host 192.168.1.2 host 192.168.2.2 eq www (4 match(es))
    deny tcp 192.168.1.0 0.0.0.255 host 192.168.2.2 eq www (39 match(es))
    permit ip any any (2 match(es))
```

Любой другой трафик (например ICMP) не блокируется, можно проверить взаимную достижимость всех хостов с помощью команды `ping`.

